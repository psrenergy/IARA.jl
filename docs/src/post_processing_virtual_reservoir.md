# Pre and post processing virtual reservoirs
The virtual reservoir representation at the market clearing problem require some pre calculation at the beginning of the run, as well at the beginning and at the ending of each period. This calculations can use input data and results from optimizing the market clearing subproblem of a previous period, and are utilized to fill and update some parameters used at the subproblem.

## Curveguide points

## Water to energy factors
For a hydro unit $h$ at a virtual reservoir $r$, the water-to-energy factor $\zeta_{r,h}$ represents the amount of energy (MWh) that can be generated by each $hm^3$ of volume at $h$ within the hydro units of reservoir $r$. To calculate this factor, we analyze the topology of the cascade to identify which hydro units within $r$ lie downstream of $h$. Specifically, we look for hydro units $g \in J^H_VR(r)$ such that there exists a path from $h$ to $g$ through intermediate units. This path is defined by a sequence of units $h, g_1, g_2, \dots, g_n, g$, where each $g_i \in J^H_VR(r)$ for all $i \in [n]$, with each unit in the sequence receiving water from the previous one: $h$ turbines water to $g_1$, $g_i$ turbines water to $g_{i+1}$, and $g_n$ turbines water to $g$.

Let $G$ be the set of possible downstream units $g$. Thus, the water-to-energy factor is given by:

$\zeta_{r,h} = \sum_{g \in G} \rho_g \cdot C_{hm^3/h \rightarrow m^3/s}$

where $\rho_j$ is the production factor of hydro unit $j$.

## Aditional energy from inflows

## Post processing energy account

At the end of each period, we want to guarantee that the sum of the energy accounts of the asset owners at a virtual reservoir is equal to the stored energy of the hydro units of this virtual reservoir. For that, we adjust the energy accounts, if necessary. The raw energy accounts can be obtained by the optimization solution: ${E^{out}_{r,i}}^*$. The stored energy of each hydro unit $h$ can be calculated based on the final volume at the optimization solution ${v^{S_{out}}_h}^*$ and the water to energy factors $\zeta_{r,h}$.

Stored energy of virtual reservoir $r$: $A=\sum_{h \in J^H_{VR}(r)} {v^{S_{out}}_h}^* \cdot \zeta_{r,h}$

Sum of energy accounts of virtual reservoir $r$: $B =\sum_{i \in I^{VR}(r)} {E^{out}_{r,i}}^*$

For each asset owner $i$ at virtual reservoir $r$, we define the post-processed energy account $E'_{r,i}$:

$E'_{r,i} = {E^{out}_{r,i}}^* \cdot \frac{A}{B}$

This way, $\sum_{i \in I^{VR}(r)} E'_{r,i} = A$, and the proportions of energy accounts at $r$ is kept.

For the next period, $E^{in}_{r,i} = E'_{r,i}$.


# Trash
- ``P^{WG}(r)``: Set of waveguide points for virtual reservoir $r$. 
- ``J^{VR}``: Set of virtual reservoirs.
- ``J^H_VR``: Set of hydro units associated with some virtual reservoir.
- ``J^H_{VR}(r)``: Set of hydro units associated with virtual reservoir $r$.
- ``I^{VR}(r)``: Set of asset owners associated with virtual reservoir $r$.
- ``P^{VR}_{r, i, k}(\omega)``: Price offer of asset owner $i$ on virtual reservoir $r$ for segment $k$ at scenario $\omega$.
- ``Q^{VR}_{r, i, k}(\omega)``: Quantity offer of asset owner $i$ on virtual reservoir $r$ for segment $k$ at scenario $\omega$.
- ``v^{WG}_{r, h, p}``: Hydro $h$ volume at waveguide point $p$ of virtual reservoir $r$.
- ``\hat{E}^{VR}_{r,i}(\omega)``: Energy account of asset owner $i$ on virtual reservoir $r$ at scenario $\omega$.
- ``\zeta_{r,h}``: Factor that converts the water volume at hydro unit $h$, where $h \in J^H_{VR}(r)$, into energy. 
- ``q^{VR}_{r, i, k}``: Total energy generated by asset owner $i$ on virtual reservoir $r$ related to segment offer $k$.
- ``\lambda^{WG}_{r, p}``: Convex combination coefficients for the waveguide point $p$ of virtual reservoir $r$.
- ``\delta^{WG}_{r, h}``: Hydro $h$ volume distance to waveguide points of virtual reservoir $r$.
- ``E^{VR}_{r,i}``: Energy account of asset owner $i$ at virtual reservoir $r$ at the end of the period.
- ``J^H``: Set of hydro units.
- ``V_j``: Maximum volume of water ($hm^3$) in the reservoir of hydro unit $j$.
- ``U_j``: Maximum amount of water ($m^3/s$) that can be turbined from the hydro unit $j$.
- ``\rho_j``: Turbine efficiency ($MW/m^3/s$) of hydro unit $j$.
- ``a_{j, \tau}``: Inflow of water ($hm^3$) into the reservoir of hydro unit $j$ at the start of subperiod $\tau$.
- ``O_j``: Minimum outflow of water ($m^3/s$) from the reservoir of hydro unit $j$.
- ``C^\eta``: Cost (``\$/hm^3``) of minimum outflow violation.
- ``C^z_j``: Cost (``\$/hm^3``) of spilling water from hydro unit $j$.
- ``\overline{G}^H_j``: Maximum generation ($MW$) of hydro unit $j$.
- ``\underline{G}^H_j``: Minimum generation ($MW$) of hydro unit $j$.
- ``g^H_{j, \tau}``: Generation ($MWh$) of hydro unit $j$ during subperiod $\tau$.
- ``v_{j, \tau}``: Volume of water ($hm^3$) in the reservoir at the start of subperiod $\tau$.
- ``u_{j, \tau}``: Turbined water ($hm^3$) from the reservoir during subperiod $\tau$.
- ``z_{j, \tau}``: Spilled water ($hm^3$) from the reservoir during subperiod $\tau$.
- ``v^{S_{in}}_j``: Volume of water ($hm^3$) in the reservoir at the start of the period.
- ``v^{S_{out}}_j``: Volume of water ($hm^3$) in the reservoir at the end of the period.
- ``a^S_{j, \tau}``: Inflow slack ($m^3/s$) of hydro unit $j$ during subperiod $\tau$.
- ``\eta_{j, \tau}``: Hydro minimum outflow violation ($hm^3$) during subperiod $\tau$.
- ``x^H_{j, \tau}``: Commitment of hydro unit $j$ during subperiod $\tau$.